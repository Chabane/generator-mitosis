---
- name: Ensure kubeadm initialization
  command: "kubeadm init --token {{worker_token}} --api-advertise-addresses={{manager_ip}} --pod-network-cidr=10.244.0.0/16"


- name: Schedule the manager
  command: "kubectl taint nodes --all dedicated-"



- name: Ensure jq package is installed
  apt:
    name: "{{ item }}"
    state: latest
  with_items:
    - jq


- name: Set --advertise-address flag in kube-apiserver static pod manifest (workaround for https://github.com/kubernetes/kubernetes/issues/34101)
  shell: "jq '.spec.containers[0].command |= .+ [\"--advertise-address={{manager_ip}}\"]' /etc/kubernetes/manifests/kube-apiserver.json > /tmp/kube-apiserver.json && mv /tmp/kube-apiserver.json /etc/kubernetes/manifests/kube-apiserver.json" 
    
- name: Set --proxy-mode flag in kube-proxy daemonset (workaround for https://github.com/kubernetes/kubernetes/issues/34101)
  shell: "kubectl -n kube-system get ds -l 'component=kube-proxy' -o json | jq '.items[0].spec.template.spec.containers[0].command |= .+ [\"--proxy-mode=userspace\"]' | kubectl apply -f - && kubectl -n kube-system delete pods -l 'component=kube-proxy'"
  register: proxy
  until: proxy.rc == 0
  retries: 20
  delay: 10

- name: Kubectl config
  command: "kubectl config set-cluster mitosis-cluster --server=http://localhost:8080 && kubectl config set-context mitosis --cluster=mitosis-cluster && kubectl config use-context mitosis"

- name: Ensure mitosis networks
  file:
    path: "{{mitosis_home}}/networks"
    state: directory
    mode: 0700

- name: Copy mitosis networks 
  copy:
    src: files/networks/{{ item }}
    dest: "{{mitosis_home}}/networks/{{ item }}"
    mode: 0700
  with_items:
    - kube-flannel.yml

- name: Start flannel
  command : "kubectl apply -f {{mitosis_home}}/networks/kube-flannel.yml"
  register: network
  until: network.rc == 0
  retries: 20
  delay: 10

- name: Ensure mitosis namespaces
  file:
    path: "{{mitosis_home}}/namespaces"
    state: directory
    mode: 0700

- name: Ensure mitosis namespaces
  file:
    path: "{{mitosis_home}}/namespaces"
    state: directory
    mode: 0700

- name: Copy mitosis namespaces 
  copy:
    src: files/services/{{ item }}
    dest: "{{mitosis_home}}/namespaces/{{ item }}"
    mode: 0700
  with_items:
    - namespace.yml

- name: Create namespace mitosis
  command: "kubectl create -f {{mitosis_home}}/namespaces/"  

- name: Ensure mitosis applications
  file:
    path: "{{mitosis_home}}/applications"
    state: directory
    mode: 0700

- name: Copy mitosis applications 
  copy:
    src: files/services/{{ item }}
    dest: "{{mitosis_home}}/applications/{{ item }}"
    mode: 0700
  with_items:
    - artifactory.yml
    - sonarqube.yml
    - jenkins.yml
    - traefik.yml

 
- name: Launch traefik
  command : "kubectl create -f {{mitosis_home}}/applications/traefik.yml"
   

  
- name: Launch sonarqube
  command : "kubectl create -f {{mitosis_home}}/applications/sonarqube.yml"
   
  
 
- name: Launch artifactory
  command : "kubectl create -f {{mitosis_home}}/applications/artifactory.yml"
   

 
- name: Launch jenkins
  command : "kubectl create -f {{mitosis_home}}/applications/jenkins.yml"
   


